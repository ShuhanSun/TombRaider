<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯»é¾™è¯€:ç»åœ°æ±‚ç”Ÿ (v35.0 Fixed)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; touch-action: none; font-family: 'Courier New', monospace; user-select: none; -webkit-user-select: none; }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Joystick */
        #joystick-zone { position: absolute; bottom: 50px; right: 50px; width: 140px; height: 140px; pointer-events: auto; border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; background: radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,0.4) 100%); transition: opacity 0.3s; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(180, 140, 90, 0.9); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 15px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.3); }
        
        /* HUD */
        .hud { position: absolute; color: #d4c4a8; text-shadow: 2px 2px 4px #000; pointer-events: none; font-weight: bold; }
        #top-bar { top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        #hp-bar { font-size: 32px; color: #b71c1c; letter-spacing: 2px; filter: drop-shadow(0 0 5px #b71c1c); }
        #level-info { text-align: right; font-size: 16px; line-height: 1.5; color: #aaa; }
        #level-num { font-size: 24px; color: #ffd700; display: block; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        #artifact-bar { margin-top: 5px; color: #f1c40f; }
        
        /* Item Bar */
        #item-bar { position: absolute; top: 70px; left: 20px; display: flex; gap: 10px; }
        .item-slot { 
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; 
            border: 1px solid #5d4037; color: #ffd700; font-size: 14px; 
            display: flex; align-items: center; gap: 5px;
            animation: fadeIn 0.5s;
        }
        .item-slot span { font-size: 18px; }
        
        /* Buff Icons */
        #buff-bar { position: absolute; top: 110px; left: 20px; display: flex; flex-direction: column; gap: 10px; }
        .buff { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; border-left: 3px solid; font-size: 14px; color: #fff; animation: fadeIn 0.5s; }
        .buff-hoof { border-color: #a1887f; }
        .buff-candle { border-color: #ff5252; }
        .buff-jade { border-color: #a5d6a7; color: #a5d6a7; }
        
        /* Message Toast */
        #msg-box { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 26px; color: #fff; font-weight: bold; text-shadow: 0 0 10px #000; opacity: 0; transition: opacity 0.5s; z-index: 10; pointer-events: none; }
        .msg-show { opacity: 1 !important; }

        /* Level Title Overlay */
        #level-title-box {
            position: absolute; top: 40%; width: 100%; text-align: center; 
            pointer-events: none; opacity: 0; transition: opacity 1s; z-index: 50;
        }
        #level-title-text {
            font-size: 48px; color: #ffd700; font-family: "Times New Roman", serif;
            text-shadow: 0 0 20px #000, 0 0 10px #ff6f00; letter-spacing: 5px;
        }
        .show-level-title { animation: fadeInOut 3s forwards; }

        /* Fullscreen Overlays */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 200; pointer-events: auto; 
            display: none; opacity: 0; transition: opacity 0.5s;
        }
        .overlay.active { display: flex; opacity: 1; }
        
        /* Item Card */
        #item-card {
            background: linear-gradient(145deg, #1a120b, #2c1e16); border: 2px solid #8d6e63;
            padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); max-width: 80%; width: 300px;
        }
        #item-icon { font-size: 80px; margin-bottom: 20px; display: block; animation: floatIcon 3s ease-in-out infinite; }
        #item-title { color: #ffd700; font-size: 32px; margin: 0 0 15px 0; font-family: "Times New Roman", serif; border-bottom: 1px solid #5d4037; padding-bottom: 10px; }
        #item-desc { color: #d7ccc8; font-size: 16px; line-height: 1.6; margin-bottom: 30px; }
        .btn { padding: 12px 35px; font-size: 20px; background: #3e2723; color: #ffd700; border: 1px solid #8d6e63; cursor: pointer; font-family:serif; pointer-events: auto; user-select: none; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }

        /* End Screens */
        #end-title { font-size: 60px; color: #d32f2f; font-family: "Times New Roman"; margin-bottom: 20px; text-shadow: 0 0 20px #f00; }
        #win-title { font-size: 60px; color: #ffd700; font-family: "Times New Roman"; margin-bottom: 20px; text-shadow: 0 0 20px #ff0; }
        
        /* Start Screen */
        #start-screen { background: #080808; z-index: 100; text-align: center; overflow-y: auto; }
        h1 { font-size: 56px; margin: 20px 0 10px 0; color: #ffd700; text-shadow: 0 0 25px rgba(212, 160, 23, 0.6); font-family: "Times New Roman", serif; letter-spacing: 8px; }
        .intro-box {
            text-align: left; background: #1a1a1a; padding: 25px; margin-top:20px; border-radius: 8px; border: 2px solid #3e2723; max-width: 85%; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .intro-text { 
            color: #ffca28; text-shadow: 0 0 8px rgba(255, 193, 7, 0.3); font-size: 15px; 
            line-height: 1.8; margin-bottom: 15px; text-indent: 2em; font-weight: 500;
        }
        .footer { margin-top: 30px; color: #555; font-size: 12px; font-family: sans-serif; }
        
        /* Lang Switch */
        #lang-switch {
            position: absolute; top: 20px; right: 20px;
            color: #888; cursor: pointer; font-size: 16px; border: 1px solid #444; padding: 5px 10px; border-radius: 4px;
        }
        #lang-switch:hover { color: #fff; border-color: #777; }

        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
        @keyframes fadeInOut { 0% { opacity:0; transform:scale(0.8); } 20% { opacity:1; transform:scale(1.1); } 80% { opacity:1; transform:scale(1); } 100% { opacity:0; transform:scale(1.2); } }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="ui-layer">
    <div id="top-bar" class="hud">
        <div id="hp-bar">â¤â¤â¤â¤â¤</div>
        <div id="level-info">
            <span id="level-num">ç¬¬ 1 å±‚</span>
            <!-- Removed Trap/Map Name from here as requested -->
            <div id="artifact-bar"><span id="art-label">å†¥å™¨</span>: 0/10</div>
        </div>
    </div>
    <div id="item-bar"></div>
    <div id="buff-bar"></div>
    <div id="msg-box"></div>
    <div id="level-title-box"><div id="level-title-text"></div></div>
    <div id="joystick-zone"><div id="joystick-knob"></div></div>
</div>

<!-- Item Modal -->
<div id="item-modal" class="overlay">
    <div id="item-card">
        <span id="item-icon">ğŸ“¦</span>
        <h2 id="item-title">ç‰©å“</h2>
        <p id="item-desc">æè¿°</p>
        <button class="btn" onclick="Game.closeModal()" id="modal-btn-text">æ”¶å…¥å›Šä¸­</button>
    </div>
</div>

<!-- Exit Confirm Modal -->
<div id="exit-modal" class="overlay">
    <div id="item-card">
        <span id="item-icon">ğŸ•³ï¸</span>
        <h2 id="exit-title" style="color:#ffd700">å‘ç°ç›—æ´</h2>
        <button class="btn" onclick="Game.confirmNextLevel()" style="margin-top:20px; font-size:24px; padding:15px 40px;">è¿›å…¥ä¸‹ä¸€å±‚</button>
    </div>
</div>

<!-- Game Over Screen -->
<div id="game-over-modal" class="overlay">
    <h2 id="end-title">èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</h2>
    <p style="color:#ccc; margin-bottom:30px" id="end-desc">å¤§ä¾ è¯·é‡æ–°æ¥è¿‡</p>
    <button class="btn" onclick="Game.restart()" id="end-btn">å†æ¢å¤å¢“</button>
</div>

<!-- Victory Screen -->
<div id="victory-modal" class="overlay">
    <h2 id="win-title">æ‘¸é‡‘æ ¡å°‰ å‡¯æ—‹</h2>
    <div style="font-size:80px; margin-bottom:20px">ğŸ†</div>
    <p style="color:#ffd700; font-size:20px; margin-bottom:30px" id="win-desc">æ‰¾åˆ°å†¥å™¨ï¼Œé€ƒå‡ºç”Ÿå¤©ï¼</p>
    <button class="btn" onclick="Game.restart()" id="win-btn">å†æ¥ä¸€å±€</button>
</div>

<!-- Start Screen -->
<div id="start-screen" class="overlay active">
    <div id="lang-switch" onclick="Game.toggleLang()">ä¸­æ–‡ / English</div>
    <h1 id="game-title">å¯»é¾™è¯€</h1>
    <p style="color:#ffd700; letter-spacing: 2px; text-shadow: 0 0 5px #ff6f00;" id="game-ver">ç»åœ°æ±‚ç”Ÿ V35.0</p>
    
    <div class="intro-box">
        <p class="intro-text" id="intro-p1">
            ä¼ è¯´ä¸­çš„å¤å¢“åŸ‹è—ç€æ— æ•°é‡‘é“¶è´¢å®ï¼Œä½†ä¹Ÿç”±å¤ä»£æœºå…³å’Œå¤æ´»çš„åƒµå°¸å®ˆå«ã€‚ç©å®¶æ‰®æ¼”ä¸€åæ‘¸é‡‘æ ¡å°‰ï¼Œéœ€æ·±å…¥åå±‚åœ°ä¸‹è¿·å®«ã€‚æ¯ä¸€å±‚éƒ½æœ‰æ— æ•°å±é™©ï¼Œåªæœ‰å¼€å¯æ£ºæï¼Œ<b>æ‰¾åˆ°é•‡å¢“å†¥å™¨</b>ï¼Œæ‰èƒ½æ‰“å¼€é€šå¾€ä¸‹ä¸€å±‚çš„ç›—æ´ï¼Œå¸¦ç€è£è€€é‡è¿”äººé—´ã€‚
        </p>
    </div>
    
    <button class="btn" style="margin-top:30px" onclick="Game.init()" id="start-btn-text">ç‚¹ç¯æ‘¸é‡‘</button>
    
    <div class="footer">
        Â© 2025 Shuhan Sun. All Rights Reserved.<br>
        Developed for TombRaider Survival Project.
    </div>
</div>

<script>
/**
 * TombRaider_Survival v35.0 Fixed
 * Updates: Slower Player Speed, Empty Coffin Text, Removed Map Name from Top-Right, Visible Feet Color.
 */

const CONFIG = { TILE: 50, BASE_SIGHT: 300, ZOMBIE_SPD: 55, SPRINTER_SPD: 140 };
const TERRAIN = { FLOOR: 0, WALL: 1, WATER: 2 };

const LEVEL_NAMES_CN = ["æ²™æµ·è¿·å†¢", "åƒçº¹æœºå…³å»Š", "é’é“œå…½å½±å…", "å·¨é¼ç‚¼é­‚å®¤", "çŸ³éª¨è¿·å®«", "è§å…‰æ£ºæ²³", "ä¹å­—å°å°äº•", "æš—å½±è‘¬ä¸»æ®¿", "å¸ç‹æ²‰çœ å®¤", "æ°¸åŠ«å¤©é™¨å¡”"];
const LEVEL_NAMES_EN = ["Sand Sea Tomb", "Thousand Traps", "Bronze Beast Hall", "Cauldron Chamber", "Bone Labyrinth", "Fluorescent River", "Nine Seal Well", "Shadow Burial", "Emperor's Sleep", "Eternal Fall Tower"];

const TRAP_NAMES_CN = ["è¿å¼©å¡”", "æŠ•çŸ³æœº", "æ»šæœ¨é˜µ", "å–·ç«å£", "æ··åˆé˜µ", "é£åˆ€å£", "å·¨çŸ³é˜µ", "é¬¼ç«é˜µ", "ä¸‡ç®­é˜µ", "ç»å¢ƒå¡”"];
const TRAP_NAMES_EN = ["Crossbow", "Catapult", "Log Trap", "Flamer", "Mix Trap", "Knives", "Boulders", "Ghost Fire", "Arrow Rain", "Despair Tower"];

const LEVELS_DATA = [
    { delay: 1.5, type: 'ARROW', col: '#5d4037' }, { delay: 2.0, type: 'STONE', col: '#4e342e' },
    { delay: 2.5, type: 'LOG', col: '#3e2723' }, { delay: 3.0, type: 'FIRE', col: '#bf360c' },
    { delay: 1.8, type: 'MIX', col: '#263238' }, { delay: 1.2, type: 'ARROW', col: '#455a64' },
    { delay: 4.0, type: 'STONE', col: '#33691e' }, { delay: 3.0, type: 'FIRE', col: '#311b92' },
    { delay: 1.0, type: 'ARROW', col: '#212121' }, { delay: 2.0, type: 'MIX', col: '#b71c1c' }
];

const WALL_COLORS = ['#4e342e', '#3e2723', '#263238', '#1b1b1b', '#37474f', '#212121', '#1a237e', '#b71c1c', '#004d40', '#000000'];

const ARTIFACTS = [
    {n: "æˆ˜å›½ç‰è‰", en: "Jade Cicada", i: "ğŸª²", d: "ç‰è´¨æ¸©æ¶¦ï¼Œå«äºå£ä¸­å¯ä¿å°¸èº«ä¸è…ã€‚", end: "Keeps the body from decaying."},
    {n: "é”™é‡‘é“œé•œ", en: "Gold Mirror", i: "ğŸ“€", d: "ç²¾ç¾çš„é’é“œé•œï¼ŒèƒŒé¢é”™é‡‘å·¥è‰ºç¹å¤ã€‚", end: "Exquisite bronze craftsmanship."},
    {n: "ç›˜é¾™é‡‘å°", en: "Dragon Seal", i: "ğŸ§§", d: "ç‹ä¾¯ä¹‹å°ï¼Œç›˜é¾™é’®æ ©æ ©å¦‚ç”Ÿã€‚", end: "Seal of an ancient prince."},
    {n: "è±¡ç‰™é…’æ¯", en: "Ivory Cup", i: "ğŸ·", d: "è±¡ç‰™é›•åˆ»è€Œæˆçš„é…’æ¯ï¼Œä»·å€¼è¿åŸã€‚", end: "Priceless ivory carving."},
    {n: "æ°´æ™¶å¤´éª¨", en: "Crystal Skull", i: "ğŸ’€", d: "é€šä½“é€æ˜çš„æ°´æ™¶å¤´éª¨ï¼Œçœ¼ç¥æ·±é‚ƒã€‚", end: "Mysterious transparent skull."},
    {n: "è¶Šç‹å¤å‰‘", en: "King's Sword", i: "ğŸ—¡ï¸", d: "åƒå¹´ä¸é”ˆï¼Œå¯’å…‰å‡›å‡›çš„ç»ä¸–åå‰‘ã€‚", end: "Sharp after thousands of years."},
    {n: "å‡¤å¤´é‡‘é’—", en: "Phoenix Pin", i: "ğŸ¥¢", d: "å®«å»·å¾¡ç”¨é‡‘é’—ï¼Œåšå·¥æå°½å¥¢åã€‚", end: "Luxury from the royal court."},
    {n: "å¤œæ˜é¾™ç ", en: "Night Pearl", i: "ğŸ”®", d: "é»‘æš—ä¸­å‘å‡ºå¹½å¹½ç»¿å…‰çš„ç¨€ä¸–å¥‡çã€‚", end: "Glows in the dark."},
    {n: "ä¼ å›½ç‰çº", en: "Imperial Seal", i: "ğŸ‘‘", d: "å—å‘½äºå¤©ï¼Œæ—¢å¯¿æ°¸æ˜Œã€‚", end: "Symbol of supreme power."},
    {n: "å½¼å²¸èŠ±",   en: "Equinox Flower", i: "ğŸŒº", d: "é€šå¾€å½¼å²¸çš„ç¥ç§˜ä¹‹èŠ±ï¼Œç»ˆæå®è—ã€‚", end: "The ultimate treasure."}
];

const SPECIAL_ITEMS = ['item_candle', 'item_wine', 'item_hoof', 'item_jade', 'item_compass'];
const PROJ_TYPES = {
    ARROW: { spd: 350, size: 3, col: '#eee', trail: true },
    STONE: { spd: 180, size: 10, col: '#795548', trail: false },
    FIRE: { spd: 220, size: 6, col: '#ff5722', trail: true },
    LOG: { spd: 150, size: 15, col: '#5d4037', trail: false, shape: 'rect' }
};

// --- Localization ---
const LANG = {
    CN: {
        title: "å¯»é¾™è¯€",
        ver: "ç»åœ°æ±‚ç”Ÿ V35.0",
        p1: "ä¼ è¯´ä¸­çš„å¤å¢“åŸ‹è—ç€æ— æ•°é‡‘é“¶è´¢å®ï¼Œä½†ä¹Ÿç”±å¤ä»£æœºå…³å’Œå¤æ´»çš„åƒµå°¸å®ˆå«ã€‚ç©å®¶æ‰®æ¼”ä¸€åæ‘¸é‡‘æ ¡å°‰ï¼Œéœ€æ·±å…¥åå±‚åœ°ä¸‹è¿·å®«ã€‚æ¯ä¸€å±‚éƒ½æœ‰æ— æ•°å±é™©ï¼Œåªæœ‰å¼€å¯æ£ºæï¼Œ<b>æ‰¾åˆ°é•‡å¢“å†¥å™¨</b>ï¼Œæ‰èƒ½æ‰“å¼€é€šå¾€ä¸‹ä¸€å±‚çš„ç›—æ´ï¼Œå¸¦ç€è£è€€é‡è¿”äººé—´ã€‚",
        startBtn: "ç‚¹ç¯æ‘¸é‡‘",
        level: "ç¬¬ %s å±‚",
        trapLabel: "æœºå…³",
        artLabel: "å†¥å™¨",
        modalBtn: "æ”¶å…¥å›Šä¸­",
        endTitle: "èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹",
        endDesc: "å¤§ä¾ è¯·é‡æ–°æ¥è¿‡",
        endBtn: "å†æ¢å¤å¢“",
        winTitle: "æ‘¸é‡‘æ ¡å°‰ å‡¯æ—‹",
        winDesc: "æ‰¾åˆ°å†¥å™¨ï¼Œé€ƒå‡ºç”Ÿå¤©ï¼",
        winBtn: "å†æ¥ä¸€å±€",
        items: {
            candle: {n:"åƒå¹´æ²¹ç¯", d:"<b>é•¿æ˜ä¸ç­</b>: è§†é‡å¤§å¹…æ‰©å¤§ã€‚"},
            wine: {n:"ç³¯ç±³é…’", d:"<b>ç¥›é˜´è¡¥é˜³</b>: æ¢å¤ 1 ç‚¹ç”Ÿå‘½å€¼ã€‚"},
            hoof: {n:"é»‘é©´è¹„å­", d:"<b>ç”Ÿäººå‹¿è¿‘</b>: åƒµå°¸é€€é¿ 15 ç§’ã€‚"},
            jade: {n:"é‡‘ç¼•ç‰è¡£", d:"<b>åˆ€æªä¸å…¥</b>: å…ç–«æœºå…³ä¼¤å®³ 15 ç§’ã€‚"},
            compass: {n:"é£æ°´ç½—ç›˜", d:"<b>å¯»é¾™åˆ†é‡‘</b>: æŒ‡å‘å†¥å™¨æ£ºæï¼Œå¾—æ‰‹åæŒ‡å‘ç›—æ´ã€‚"}
        },
        msgs: {
            start: "è¿›å…¥ç¬¬ %s å±‚",
            hurt: "å—åˆ°ä¼¤å®³!",
            empty: "ç©ºç©ºå¦‚ä¹Ÿ...",
            trap: "å¤§å‡¶! æœºå…³è§¦å‘!",
            zombie: "èµ·å°¸äº†!",
            candle: "ç¯ç«é€šæ˜!",
            compass: "ç½—ç›˜åœ¨æ‰‹! å¯»é¾™åˆ†é‡‘!",
            heal: "ç”Ÿå‘½æ¢å¤!",
            repel: "å°¸ç• 15ç§’!",
            immune: "æ— è§†æœºå…³ 15ç§’!",
            hole: "ç›—æ´å·²å¼€å¯! æ°´è„‰é€†æµ!"
        },
        levelNames: LEVEL_NAMES_CN,
        trapNames: TRAP_NAMES_CN,
        labels: { coffin: "çŸ³æ£º", exit: "ç›—æ´", sprinter: "ç–¾è¡Œå°¸" },
        exitModal: { t: "å‘ç°ç›—æ´", d: "æ˜¯å¦è¿›å…¥ä¸‹ä¸€å±‚ï¼Ÿ<br>(è¿›å…¥åæ— æ³•è¿”å›)", yes: "è¿›å…¥ä¸‹ä¸€å±‚", no: "æš‚ä¸è¿›å…¥" }
    },
    EN: {
        title: "Tomb Raider",
        ver: "Survival V35.0",
        p1: "Ancient tombs hold countless treasures. As a Raider, descend 10 levels. Find the <b>Artifact</b> to unlock the exit. Use the Feng Shui Compass to guide your way.",
        startBtn: "Start Raid",
        level: "Level %s",
        trapLabel: "Trap",
        artLabel: "Relic",
        modalBtn: "Collect",
        endTitle: "You Died",
        endDesc: "Better luck next time.",
        endBtn: "Try Again",
        winTitle: "Victory!",
        winDesc: "Artifacts found. You survived!",
        winBtn: "Play Again",
        items: {
            candle: {n:"Ancient Lamp", d:"<b>Eternal Flame</b>: Max Vision Range."},
            wine: {n:"Rice Wine", d:"<b>Vitality</b>: Restore 1 HP."},
            hoof: {n:"Donkey Hoof", d:"<b>Repel</b>: Zombies fear you for 15s."},
            jade: {n:"Jade Suit", d:"<b>Invincible</b>: Immune to traps for 15s."},
            compass: {n:"Compass", d:"<b>Feng Shui</b>: Points to Artifact, then Exit."}
        },
        msgs: {
            start: "Entered Level %s",
            hurt: "Took Damage!",
            empty: "Empty...",
            trap: "Trap Triggered!",
            zombie: "Zombie Rise!",
            candle: "Lamp Lit!",
            compass: "Compass Active!",
            heal: "HP Restored!",
            repel: "Repel 15s!",
            immune: "Immune 15s!",
            hole: "Exit Opened! Water Rising!"
        },
        levelNames: LEVEL_NAMES_EN,
        trapNames: TRAP_NAMES_EN,
        labels: { coffin: "Coffin", exit: "Exit", sprinter: "Sprinter" },
        exitModal: { t: "Exit Found", d: "Enter next level?<br>(No return)", yes: "Enter", no: "Stay" }
    }
};

let curLang = 'CN';

// --- Audio ---
const AudioSys = {
    ctx: null, gain: null,
    init: function() {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.gain = this.ctx.createGain();
            this.gain.gain.value = 0.5;
            this.gain.connect(this.ctx.destination);
            const d=this.ctx.createDelay(); d.delayTime.value=0.2;
            const dg=this.ctx.createGain(); dg.gain.value=0.2;
            this.gain.connect(d); d.connect(dg); dg.connect(this.ctx.destination);
            this.ctx.resume();
        } catch(e) {}
    },
    tone: function(f, type, dur, vol=0.1, slide=null) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(f, t);
        if(slide) osc.frequency.linearRampToValueAtTime(slide, t+dur);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(vol, t+dur*0.1);
        g.gain.exponentialRampToValueAtTime(0.001, t+dur);
        osc.connect(g); g.connect(this.gain);
        osc.start(t); osc.stop(t+dur+0.2);
    },
    playStep: function() { if(this.ctx) this.tone(60, 'square', 0.1, 0.15, 30); },
    playOpen: function() {
        if(!this.ctx) return;
        const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain(), f=this.ctx.createBiquadFilter();
        o.type='triangle'; o.frequency.setValueAtTime(50,t); o.frequency.exponentialRampToValueAtTime(30,t+0.8);
        f.type='lowpass'; f.frequency.value=200;
        g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.6,t+0.1); g.gain.linearRampToValueAtTime(0,t+1.0);
        o.connect(f); f.connect(g); g.connect(this.gain); o.start(t); o.stop(t+1.1);
    },
    playItem: function(s) { 
        if(s) { this.tone(523, 'sine', 0.5, 0.2); setTimeout(()=>this.tone(784, 'sine', 1.0, 0.2), 100); }
        else this.tone(880, 'sine', 0.1, 0.1);
    },
    playTrap: function(dist) { 
        const maxDist = 600; if(dist > maxDist) return;
        const vol = Math.max(0, 1 - dist/maxDist) * 0.4;
        this.tone(600, 'sawtooth', 0.2, vol, 200); 
    },
    playAttack: function() { this.tone(150, 'sawtooth', 0.3, 0.3, 50); },
    playHurt: function() { this.tone(120, 'sawtooth', 0.3, 0.5, 80); setTimeout(()=>this.tone(80, 'square', 0.2, 0.3), 100); },
    playUse: function() { this.tone(400, 'sine', 1.0, 0.2, 800); }
};

// --- Input ---
const Input = { x:0, y:0, active:false };
(function(){
    const z=document.getElementById('joystick-zone'), k=document.getElementById('joystick-knob');
    const h = (e,end)=>{
        const t=e.touches?e.touches[0]:e, r=z.getBoundingClientRect();
        if(end){Input.active=false;Input.x=0;Input.y=0;k.style.transform='translate(-50%,-50%)';return;}
        let dx=t.clientX-(r.left+r.width/2), dy=t.clientY-(r.top+r.height/2);
        const d=Math.min(Math.hypot(dx,dy),70), a=Math.atan2(dy,dx);
        Input.x=Math.cos(a)*d/70; Input.y=Math.sin(a)*d/70; Input.active=true;
        k.style.transform=`translate(calc(-50% + ${Input.x*d}px), calc(-50% + ${Input.y*d}px))`;
    };
    z.addEventListener('touchstart',e=>{e.preventDefault();h(e)},{passive:false});
    z.addEventListener('touchmove',e=>{e.preventDefault();h(e)},{passive:false});
    z.addEventListener('touchend',e=>{e.preventDefault();h(e,1)},{passive:false});
    z.addEventListener('mousedown',e=>{Input.m=1;h(e)});
    window.addEventListener('mousemove',e=>{if(Input.m)h(e)});
    window.addEventListener('mouseup',e=>{if(Input.m){Input.m=0;h(e,1)}});
})();

class FloatText {
    constructor(x,y,t,c){this.x=x;this.y=y;this.t=t;this.c=c;this.life=60;}
    update(){this.y-=0.5;this.life--;}
    draw(ctx){
        ctx.globalAlpha=this.life/60; ctx.fillStyle=this.c; ctx.font="bold 16px serif"; ctx.textAlign="center";
        ctx.fillText(this.t,this.x,this.y); ctx.globalAlpha=1;
    }
}

class Effect {
    constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.life=1.0;}
    update(dt){this.life-=dt*2; if(this.life<0)this.dead=1;}
    draw(ctx){
        ctx.save(); ctx.translate(this.x,this.y);
        ctx.globalAlpha=this.life;
        if(this.type==='gold') { 
            ctx.strokeStyle='#ffd700'; ctx.lineWidth=2;
            for(let i=0;i<8;i++){ ctx.rotate(0.785); ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(30+Math.random()*10,0); ctx.stroke(); }
        } else if(this.type==='burst') { 
            ctx.fillStyle='#b71c1c'; ctx.beginPath(); ctx.arc(0,0,(1-this.life)*50,0,6.28); ctx.fill();
        }
        ctx.restore();
    }
}

// --- Entities ---
class Entity { constructor(x,y,t){this.x=x;this.y=y;this.type=t;this.dead=0;} }

class GroundItem extends Entity {
    constructor(x,y,code) { super(x,y,'ground_item'); this.code=code; }
    update(dt, p) {
        if(Math.hypot(this.x-p.x, this.y-p.y) < 30) { Game.getItem(this.code); this.dead = 1; }
    }
    draw(ctx) {
        const iKey = this.code.replace('item_', '');
        const colors = {candle:'#ff8a80', wine:'#fff', hoof:'#a1887f', jade:'#a5d6a7', compass:'#ffd700'};
        const yOff = Math.sin(Date.now()/300)*5;
        const iconMap = {candle:'ğŸª”', wine:'ğŸ¶', hoof:'ğŸ´', jade:'ğŸ¥‹', compass:'ğŸ§­'};
        ctx.font = "24px serif"; ctx.textAlign = "center";
        ctx.fillText(iconMap[iKey], 0, yOff);
        ctx.fillStyle = '#fff'; ctx.font = "12px serif";
        ctx.fillText(LANG[curLang].items[iKey].n, 0, yOff - 20); 
        
        ctx.shadowBlur=15; ctx.shadowColor=colors[iKey];
        ctx.beginPath(); ctx.arc(0,10,8,0,6.28); ctx.fillStyle=colors[iKey]; ctx.fill(); ctx.shadowBlur=0;
    }
}

class Coffin extends Entity {
    constructor(x,y,c){super(x,y,'coffin');this.content=c;this.opened=0;this.shake=0;}
    interact() {
        if(this.opened) return;
        this.opened = 1; this.shake = 30; AudioSys.playOpen();
        setTimeout(() => {
            if(this.content === 'artifact') {
                Game.getArtifact();
                Game.addText(this.x, this.y, ARTIFACTS[Game.lvl-1][curLang==='CN'?'n':'en'], '#ffd700');
                Game.spawn(new Effect(this.x,this.y,'gold'));
            }
            else if(this.content === 'zombie') { 
                Game.spawn(new Zombie(this.x,this.y+20, 0)); 
                Game.addText(this.x, this.y, LANG[curLang].msgs.zombie, '#f44336');
                Game.spawn(new Effect(this.x,this.y,'burst'));
                AudioSys.playAttack(); 
            }
            else if(this.content === 'trap') {
                 Game.spawn(new Trap(this.x,this.y+40, Game.lvl-1));
                 Game.addText(this.x, this.y, LANG[curLang].msgs.trap, '#f44336');
                 AudioSys.playTrap(0);
            }
            else { 
                Game.addText(this.x, this.y, LANG[curLang].msgs.empty, '#aaa'); 
            }
        }, 600);
    }
    draw(ctx) {
        if(this.shake>0){ctx.translate((Math.random()-.5)*4,0);this.shake--;}
        if(!this.opened) {
            ctx.fillStyle = '#aaa'; ctx.font='12px serif'; ctx.textAlign='center';
            ctx.fillText(LANG[curLang].labels.coffin, 0, -50);
        }
        ctx.save();
        ctx.rotate(Math.PI/2); 
        if(!this.opened){
            ctx.fillStyle = '#757575'; ctx.beginPath();
            ctx.moveTo(-18, -35); ctx.lineTo(18, -35); ctx.lineTo(14, 35); ctx.lineTo(-14, 35); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#616161'; ctx.beginPath(); ctx.arc(0, -20, 5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#ffd700'; ctx.fillRect(-5,-10,10,20);
            ctx.fillStyle='#b71c1c'; ctx.font='12px serif'; ctx.textAlign="left"; ctx.fillText('æ••',-6,5);
        } else {
            ctx.fillStyle = '#212121'; ctx.beginPath();
            ctx.moveTo(-16, -33); ctx.lineTo(16, -33); ctx.lineTo(12, 33); ctx.lineTo(-12, 33); ctx.fill();
        }
        ctx.restore();
    }
}

class Zombie extends Entity {
    constructor(x,y,type=0){super(x,y,'zombie');
        this.zType = type; this.spd = type===1 ? CONFIG.SPRINTER_SPD : CONFIG.ZOMBIE_SPD + Game.lvl*5;
        this.dir = Math.random()*6.28; this.changeDirT = 0;
    }
    update(dt,p) {
        const oldX=this.x, oldY=this.y;
        const dx=p.x-this.x, dy=p.y-this.y, d=Math.hypot(dx,dy);
        let repel = p.buffs.hoof > 0;
        
        if(this.zType === 0) {
            let active = d<200 || (Input.active && d<350);
            if(active || repel) {
                let tx=dx, ty=dy, s=this.spd;
                if(repel && d<350) { tx=-dx; ty=-dy; s=this.spd*1.5; }
                if(MapSys.get(this.x,this.y)===TERRAIN.WATER) s*=0.4;
                if(!repel || d<350) {
                    this.x += (tx/d)*s*dt; if(MapSys.get(this.x,this.y)===TERRAIN.WALL) this.x=oldX; 
                    this.y += (ty/d)*s*dt; if(MapSys.get(this.x,this.y)===TERRAIN.WALL) this.y=oldY;
                }
            }
        } else { 
            this.changeDirT -= dt;
            if(this.changeDirT <= 0) { this.changeDirT = 1.0 + Math.random(); this.dir = Math.random() * 6.28; }
            let vx = Math.cos(this.dir) * this.spd; let vy = Math.sin(this.dir) * this.spd;
            this.x += vx * dt; if(MapSys.get(this.x, this.y) === TERRAIN.WALL) { this.x = oldX; this.dir = Math.PI - this.dir; }
            this.y += vy * dt; if(MapSys.get(this.x, this.y) === TERRAIN.WALL) { this.y = oldY; this.dir = -this.dir; }
        }
        if(!repel && d<20) { p.hit(); AudioSys.playAttack(); }
        this.hop = Math.abs(Math.sin(Date.now()/(this.zType===1?100:200)))*-8;
    }
    draw(ctx){
        ctx.translate(0,this.hop||0);
        if(Game.p.buffs.hoof>0) { ctx.fillStyle='#f00'; ctx.font='20px serif'; ctx.fillText('!', 0, -50); }
        const isSprinter = this.zType === 1;
        if(isSprinter) { ctx.fillStyle = '#ff5252'; ctx.font='12px serif'; ctx.textAlign='center'; ctx.fillText(LANG[curLang].labels.sprinter, 0, -50); }
        
        ctx.fillStyle = '#000'; ctx.fillRect(-10,-42,20,5); ctx.fillRect(-6,-48,12,6); // Hat
        ctx.fillStyle = isSprinter ? '#ff5252' : '#e53935'; ctx.beginPath(); ctx.arc(0,-50,3,0,6.28); ctx.fill();
        ctx.fillStyle = isSprinter ? '#b71c1c' : '#1a237e'; ctx.fillRect(-12,-25,24,25); // Robe
        ctx.fillStyle='#e0e0e0'; ctx.beginPath(); ctx.arc(0,-30,9,0,6.28); ctx.fill(); // Head
        ctx.fillStyle = isSprinter ? '#b71c1c' : '#1a237e'; ctx.fillRect(-14, -28, 6, 20); ctx.fillRect(8, -28, 6, 20); // Arms
        ctx.fillStyle='#ffea00'; ctx.fillRect(-3,-38,6,12); // Tag
    }
}

class Trap extends Entity {
    constructor(x,y,lvlIndex){
        super(x,y,'trap');
        this.life=3; this.cd=Math.random(); 
        const data = LEVELS_DATA[Math.min(lvlIndex,9)];
        this.pType = data.type === 'MIX' ? Object.keys(PROJ_TYPES)[Math.floor(Math.random()*4)] : data.type;
        this.color = data.col;
        this.name = LANG[curLang].trapNames[Math.min(lvlIndex,9)]; 
        this.lvlIdx = Math.min(lvlIndex,9);
    }
    update(dt,p){
        const dist = Math.hypot(this.x-p.x, this.y-p.y);
        if(dist < 400) {
            this.cd-=dt;
            if(this.cd<0){
                this.cd = 1.5 + Math.random()*0.5; 
                const pdx=p.x-this.x, pdy=p.y-this.y, ang=Math.atan2(pdy,pdx);
                Game.spawn(new Projectile(this.x,this.y,ang,this.pType)); 
                AudioSys.playTrap(dist);
            }
        }
    }
    draw(ctx){
        ctx.fillStyle=this.color; ctx.fillRect(-15,-20,30,20); 
        ctx.fillStyle='#212121'; ctx.beginPath(); ctx.moveTo(-15,-20); ctx.lineTo(-18,0); ctx.lineTo(18,0); ctx.lineTo(15,-20); ctx.fill();
        ctx.fillStyle='#f44336'; const pulse = 3 + Math.sin(Date.now()/100)*2; ctx.beginPath(); ctx.arc(0,-28, pulse, 0, 6.28); ctx.fill();
        ctx.fillStyle = '#ff5252'; ctx.font = 'bold 12px serif'; ctx.textAlign='center'; 
        ctx.fillText(LANG[curLang].trapNames[this.lvlIdx], 0, -45);
    }
}

class Projectile extends Entity {
    constructor(x,y,a,type){super(x,y,'proj');
        this.info = PROJ_TYPES[type] || PROJ_TYPES.ARROW;
        this.vx=Math.cos(a)*this.info.spd; this.vy=Math.sin(a)*this.info.spd;
        this.life=3.0; this.ang=a;
    }
    update(dt,p){
        this.life-=dt; if(this.life<0)this.dead=1;
        this.x+=this.vx*dt; this.y+=this.vy*dt;
        if(Math.hypot(this.x-p.x,this.y-p.y)<this.info.size+10){
            if(p.buffs.jade > 0) this.dead = 1; else { p.hit(); this.dead=1; }
        }
        if(MapSys.get(this.x,this.y)===TERRAIN.WALL) this.dead=1;
    }
    draw(ctx){
        ctx.rotate(this.ang); ctx.fillStyle=this.info.col;
        if(this.info.shape === 'rect') { ctx.fillRect(-10, -5, 20, 10); } 
        else { ctx.beginPath(); ctx.arc(0,0,this.info.size,0,6.28); ctx.fill(); }
        if(this.info.trail) { ctx.strokeStyle=this.info.col; ctx.globalAlpha=0.5; ctx.beginPath(); ctx.moveTo(-5,0); ctx.lineTo(-20,0); ctx.stroke(); ctx.globalAlpha=1; }
    }
}

class Player extends Entity {
    constructor(x,y){super(x,y,'player');this.hp=5;this.sight=CONFIG.BASE_SIGHT;this.inv=0;this.buffs={hoof:0,candle:0,jade:0};this.walkT=0;this.hasCompass=0;this.stepPhase=0;}
    update(dt){
        if(this.inv>0)this.inv-=dt;
        if(this.buffs.hoof>0) this.buffs.hoof-=dt;
        if(this.buffs.candle>0) this.buffs.candle-=dt;
        if(this.buffs.jade>0) this.buffs.jade-=dt;
        
        // Slower base speed for better control
        let s=160; 
        if(MapSys.get(this.x,this.y)===TERRAIN.WATER) s*=0.5;
        
        if(Input.active){
            const nx=this.x+Input.x*s*dt, ny=this.y+Input.y*s*dt;
            if(MapSys.get(nx,this.y)!==TERRAIN.WALL)this.x=nx;
            if(MapSys.get(this.x,ny)!==TERRAIN.WALL)this.y=ny;
            this.stepPhase += dt * 10;
            this.walkT+=dt; if(this.walkT > 0.4) { AudioSys.playStep(); this.walkT=0; }
        } else { this.stepPhase = 0; }
    }
    hit(){
        if(this.inv>0 || this.buffs.hoof>0)return;
        this.hp--; this.inv=1; Game.shake=10; AudioSys.playHurt();
        Game.updateHUD(); Game.msg(LANG[curLang].msgs.hurt,"#f00");
        if(this.hp<=0)Game.over();
    }
    draw(ctx){
        if(this.inv>0&&Date.now()%100<50)return;
        if(this.buffs.hoof>0) { ctx.beginPath(); ctx.arc(0,0,25,0,6.28); ctx.fillStyle='rgba(161,136,127,0.3)'; ctx.fill(); }
        if(this.buffs.jade>0) { ctx.beginPath(); ctx.arc(0,0,25,0,6.28); ctx.strokeStyle='#a5d6a7'; ctx.lineWidth=2; ctx.stroke(); }
        ctx.rotate(Math.atan2(Input.y,Input.x));
        const lOffset = Math.sin(this.stepPhase) * 6;
        ctx.fillStyle='#3e2723'; ctx.fillRect(-8, -5 + lOffset, 6, 12); ctx.fillRect(2, -5 + Math.sin(this.stepPhase + Math.PI) * 6, 6, 12);
        
        // Boots (Visible Color)
        ctx.fillStyle='#d7ccc8'; 
        ctx.fillRect(-8, 5 + lOffset, 6, 4); 
        ctx.fillRect(2, 5 + Math.sin(this.stepPhase + Math.PI) * 6, 6, 4);
        
        ctx.fillStyle='#5d4037'; ctx.fillRect(-10,-10,20,18); ctx.fillStyle='#8d6e63'; ctx.fillRect(-8,-8,16,10);
        ctx.fillStyle='#1a1a1a'; ctx.beginPath(); ctx.arc(0,0,7,0,6.28); ctx.fill();
        ctx.fillStyle='#ffecb3';ctx.globalAlpha=0.2;ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,50,-0.5,0.5);ctx.fill();ctx.globalAlpha=1;
        ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.arc(12, 5, 3, 0, 6.28); ctx.fill();
    }
}

// --- Map ---
const MapSys = {
    w:60, h:60, t:[], 
    gen: function(l){
        this.t=new Uint8Array(this.w*this.h).fill(1);
        const rms=[];
        for(let i=0;i<10+l;i++){
            const w=6+Math.floor(Math.random()*6), h=6+Math.floor(Math.random()*6);
            const x=2+Math.floor(Math.random()*(this.w-w-4)), y=2+Math.floor(Math.random()*(this.h-h-4));
            if(!rms.some(r=>x<r.x+r.w+1 && x+w+1>r.x && y<r.y+r.h+1 && y+h+1>r.y)){
                rms.push({x,y,w,h});
                for(let Y=y;Y<y+h;Y++)for(let X=x;X<x+w;X++) this.t[Y*this.w+X] = 0; 
                if(rms.length>1){
                    let p=rms[rms.length-2], cx1=p.x+p.w/2|0, cy1=p.y+p.h/2|0, cx2=x+w/2|0, cy2=y+h/2|0;
                    while(cx1!=cx2){cx1+=cx1<cx2?1:-1;if(this.t[cy1*this.w+cx1]==1)this.t[cy1*this.w+cx1]=0;}
                    while(cy1!=cy2){cy1+=cy1<cy2?1:-1;if(this.t[cy1*this.w+cx1]==1)this.t[cy1*this.w+cx1]=0;}
                }
            }
        }
        return rms;
    },
    get: function(px,py){
        const tx=px/CONFIG.TILE|0, ty=py/CONFIG.TILE|0;
        if(tx<0||tx>=this.w||ty<0||ty>=this.h) return 1;
        return this.t[ty*this.w+tx];
    }
};

// --- Game Engine ---
const Game = {
    cvs:document.getElementById('gameCanvas'), ctx:document.getElementById('gameCanvas').getContext('2d'),
    ents:[], texts:[], lvl:1, art:0, exit:0, pause:0, shake:0, running:0, artifactPos: null, items: [],
    
    toggleLang: function() {
        curLang = curLang === 'CN' ? 'EN' : 'CN';
        this.updateUI();
    },
    
    updateUI: function() {
        const txt = LANG[curLang];
        document.getElementById('game-title').innerText = txt.title;
        document.getElementById('game-ver').innerText = txt.ver;
        document.getElementById('intro-p1').innerHTML = txt.p1;
        document.getElementById('start-btn-text').innerText = txt.startBtn;
        document.getElementById('art-label').innerText = txt.artLabel;
        document.getElementById('modal-btn-text').innerText = txt.modalBtn;
        document.getElementById('end-title').innerText = txt.endTitle;
        document.getElementById('end-desc').innerText = txt.endDesc;
        document.getElementById('end-btn').innerText = txt.endBtn;
        document.getElementById('win-title').innerText = txt.winTitle;
        document.getElementById('win-desc').innerText = txt.winDesc;
        document.getElementById('win-btn').innerText = txt.winBtn;
        
        const exitTxt = LANG[curLang].exitModal;
        document.getElementById('exit-title').innerText = exitTxt.t;
    },

    init: function(){
        this.resize(); window.onresize=()=>this.resize();
        document.getElementById('start-screen').style.display='none';
        AudioSys.init(); 
        this.restart();
    },
    
    restart: function() {
        this.lvl = 1; this.art = 0; this.saved = null; this.items = [];
        document.getElementById('game-over-modal').classList.remove('active');
        document.getElementById('victory-modal').classList.remove('active');
        this.running = 1;
        this.load(1); this.loop();
    },
    
    resize: function(){this.cvs.width=window.innerWidth;this.cvs.height=window.innerHeight;},
    
    closeModal: function() {
        document.getElementById('item-modal').classList.remove('active');
        this.pause = false;
        if(this.pendingEffect) { this.pendingEffect(); this.pendingEffect = null; }
    },
    
    showExitModal: function() {
        document.getElementById('exit-modal').classList.add('active');
        this.pause = true;
    },
    cancelExit: function() {
        document.getElementById('exit-modal').classList.remove('active');
        this.pause = false;
        this.p.y -= 60; 
    },
    confirmNextLevel: function() {
        document.getElementById('exit-modal').classList.remove('active');
        this.pause = false;
        if(this.lvl>=10){ this.victory(); }
        else {
            this.saved={hp:this.p.hp}; 
            this.load(this.lvl+1);
        }
    },
    
    addText: function(x, y, text, color) {
        this.texts.push(new FloatText(x, y, text, color));
    },
    
    addItemIcon: function(icon) {
        const bar = document.getElementById('item-bar');
        const el = document.createElement('div');
        el.className = 'item-slot';
        el.innerHTML = `<span>${icon}</span>`;
        bar.appendChild(el);
        setTimeout(() => el.remove(), 15000);
    },

    load: function(l){
        this.lvl=l; this.ents=[]; this.texts=[]; this.exit=0; this.artifactPos = null;
        document.getElementById('item-bar').innerHTML = ''; 
        
        const rms=MapSys.gen(l), s=rms[0], e=rms[rms.length-1];
        this.p=new Player((s.x+s.w/2)*CONFIG.TILE, (s.y+s.h/2)*CONFIG.TILE);
        if(this.saved) { this.p.hp=this.saved.hp; }
        this.ents.push(this.p);
        
        const corners=[];
        rms.forEach(r => {
             corners.push({x:r.x*CONFIG.TILE+25, y:r.y*CONFIG.TILE+25});
             corners.push({x:(r.x+r.w)*CONFIG.TILE-25, y:(r.y+r.h)*CONFIG.TILE-25});
        });
        
        ['item_wine', 'item_hoof', 'item_jade', 'item_candle', 'item_candle', 'item_candle', 'item_compass'].forEach(code => {
             if(corners.length>0) {
                 const ri = Math.floor(Math.random()*corners.length);
                 this.ents.push(new GroundItem(corners[ri].x, corners[ri].y, code));
                 corners.splice(ri,1);
             }
        });
        
        const spots=[];
        for(let i=1;i<rms.length-1;i++) spots.push({x:(rms[i].x+rms[i].w/2)*CONFIG.TILE, y:(rms[i].y+rms[i].h/2)*CONFIG.TILE});
        
        if(spots.length>0) {
            const ai = Math.floor(Math.random()*spots.length);
            this.ents.push(new Coffin(spots[ai].x, spots[ai].y, 'artifact'));
            this.artifactPos = {x: spots[ai].x, y: spots[ai].y};
            spots.splice(ai,1);
        }
        
        spots.forEach(p => {
             const c = Math.random()<0.5?'empty':'zombie';
             this.ents.push(new Coffin(p.x, p.y, c));
        });
        
        const trapCount = Math.floor(1 + Math.pow(l, 1.2)); 
        let trapsPlaced = 0;
        const lData = LEVELS_DATA[Math.min(l-1, 9)];
        while(trapsPlaced < trapCount) {
             const r=rms[Math.floor(Math.random()*rms.length)];
             const tx = (r.x + 1 + Math.floor(Math.random()*(r.w-2))) * CONFIG.TILE;
             const ty = r.y * CONFIG.TILE; 
             let tType = lData.type;
             if(tType === 'MIX') tType = Object.keys(PROJ_TYPES)[Math.floor(Math.random()*4)];
             this.ents.push(new Trap(tx, ty, l-1));
             trapsPlaced++;
        }
        
        this.exitRoom = e;
        this.exitPos = {x:(e.x+e.w/2)*CONFIG.TILE, y:e.y*CONFIG.TILE};
        
        for(let i=0;i<4+l*2;i++){
            const r=rms[Math.floor(Math.random()*rms.length)];
            const isSprinter = Math.random() < 0.2 ? 1 : 0;
            this.ents.push(new Zombie((r.x+2)*CONFIG.TILE, (r.y+2)*CONFIG.TILE, isSprinter));
        }
        this.updateHUD(); 
        
        const lName = LANG[curLang].levelNames[Math.min(l-1,9)];
        const splash = document.getElementById('level-title-text');
        splash.innerText = lName;
        document.getElementById('level-title-box').classList.remove('show-level-title');
        void document.getElementById('level-title-box').offsetWidth;
        document.getElementById('level-title-box').classList.add('show-level-title');
    },
    
    showModal: function(t,i,d,c) {
        document.getElementById('item-title').innerText=t; document.getElementById('item-title').style.color=c||'#ffd700';
        document.getElementById('item-icon').innerText=i; document.getElementById('item-desc').innerHTML=d;
        document.getElementById('item-modal').classList.add('active'); this.pause=true;
    },
    
    getArtifact: function() {
        AudioSys.playItem(true);
        const a = ARTIFACTS[this.lvl-1];
        const name = curLang === 'CN' ? a.n : a.en;
        const desc = curLang === 'CN' ? a.d : a.end;
        this.showModal(name, a.i, desc);
        this.pendingEffect = ()=>{
            this.art++; this.exit=1; 
            this.msg(LANG[curLang].msgs.hole, "#0f0"); 
            this.updateHUD();
            
            // Flood
            const r = this.exitRoom;
            for(let y=r.y; y<r.y+r.h; y++){
                for(let x=r.x; x<r.x+r.w; x++){
                     if(MapSys.get(x*CONFIG.TILE, y*CONFIG.TILE) === TERRAIN.FLOOR) {
                         MapSys.t[y*MapSys.w+x] = 2;
                     }
                }
            }
        };
    },
    getItem: function(c) {
        AudioSys.playItem(true);
        const key = c.replace('item_','');
        const item = LANG[curLang].items[key];
        const colors = {candle:'#ff8a80', wine:'#fff', hoof:'#a1887f', jade:'#a5d6a7', compass:'#ffd700'};
        const col = colors[key];
        const iconMap = {candle:'ğŸª”', wine:'ğŸ¶', hoof:'ğŸ´', jade:'ğŸ¥‹', compass:'ğŸ§­'};
        
        this.showModal(item.n, iconMap[key], item.d, col);
        this.pendingEffect = ()=>{
            AudioSys.playUse();
            if(c==='item_candle'){ this.p.sight+=150; this.msg(LANG[curLang].msgs.candle, col); this.addItemIcon('ğŸª”'); }
            if(c==='item_compass'){ this.p.hasCompass=1; this.msg(LANG[curLang].msgs.compass, col); this.addItemIcon('ğŸ§­'); }
            if(c==='item_wine'){ this.p.hp=Math.min(5,this.p.hp+1); this.msg(LANG[curLang].msgs.heal, col); this.updateHUD(); }
            if(c==='item_hoof'){ this.p.buffs.hoof=15; this.msg(LANG[curLang].msgs.repel, col); this.addItemIcon('ğŸ´'); }
            if(c==='item_jade'){ this.p.buffs.jade=15; this.msg(LANG[curLang].msgs.immune, col); this.addItemIcon('ğŸ¥‹'); }
        };
    },
    
    spawn: function(e){this.ents.push(e);},
    msg: function(t,c){const b=document.getElementById('msg-box');b.innerHTML=t;b.style.color=c;b.classList.add('msg-show');setTimeout(()=>b.classList.remove('msg-show'),2000);},
    updateHUD: function(){
        document.getElementById('hp-bar').innerText="â¤".repeat(this.p.hp);
        document.getElementById('level-num').innerText = LANG[curLang].level.replace('%s', this.lvl);
        document.getElementById('artifact-bar').innerText = `${LANG[curLang].artLabel}: ${this.art}/10`;
    },
    over: function(){
        this.running=0;
        document.getElementById('game-over-modal').classList.add('active');
    },
    victory: function(){
        this.running=0;
        document.getElementById('victory-modal').classList.add('active');
    },
    
    loop: function(){
        if(!this.running) return;
        requestAnimationFrame(()=>this.loop());
        if(this.pause) return;
        if(this.shake>0)this.shake*=.9;
        
        const bb = document.getElementById('buff-bar'); bb.innerHTML='';
        if(this.p.buffs.hoof>0) bb.innerHTML+=`<div class="buff buff-hoof">ğŸ´ ${Math.ceil(this.p.buffs.hoof)}s</div>`;
        if(this.p.buffs.jade>0) bb.innerHTML+=`<div class="buff buff-jade">ğŸ¥‹ ${Math.ceil(this.p.buffs.jade)}s</div>`;
        if(this.p.hasCompass) bb.innerHTML+=`<div class="buff buff-compass">ğŸ§­ ON</div>`;
        
        const dt=0.016; // Fixed step for consistency
        this.ents = this.ents.filter(e=>!e.dead);
        this.ents.sort((a,b)=>a.y-b.y);
        
        this.ents.forEach(e=>{
            if(e.update) e.type==='zombie'||e.type==='trap'||e.type==='proj'||e.type==='ground_item'||e.type==='effect'?e.update(dt,this.p):e.update(dt);
            if(e.type==='coffin'&&!e.opened&&Math.hypot(e.x-this.p.x,e.y-this.p.y)<40) e.interact();
        });
        
        this.texts = this.texts.filter(t=>t.life>0);
        this.texts.forEach(t=>t.update());
        
        if(this.exit && Math.hypot(this.exitPos.x-this.p.x, this.exitPos.y-this.p.y)<30){
            this.showExitModal();
        }
        this.render();
    },
    
    render: function(){
        const w=this.cvs.width, h=this.cvs.height, ctx=this.ctx;
        let cx=this.p.x-w/2 + (Math.random()-.5)*this.shake, cy=this.p.y-h/2 + (Math.random()-.5)*this.shake;
        
        ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
        ctx.save(); ctx.translate(-cx,-cy);
        
        const cs=Math.floor(cx/CONFIG.TILE), ce=cs+w/CONFIG.TILE+2;
        const rs=Math.floor(cy/CONFIG.TILE), re=rs+h/CONFIG.TILE+2;
        const wallCol = WALL_COLORS[Math.min(this.lvl-1,9)];
        const now = Date.now();
        
        for(let y=rs;y<re;y++)for(let x=cs;x<ce;x++){
            if(x>=0&&x<MapSys.w&&y>=0&&y<MapSys.h){
                const t = MapSys.t[y*MapSys.w+x];
                const px=x*CONFIG.TILE, py=y*CONFIG.TILE;
                
                if(t==0){ 
                    ctx.fillStyle='#2d241e'; ctx.fillRect(px,py,50,50);
                    ctx.fillStyle='rgba(0,0,0,0.1)'; if((x+y)%5===0) ctx.fillRect(px+10,py+10,5,5);
                } 
                else if(t==2) { 
                    ctx.fillStyle='#01579b';ctx.fillRect(px,py,50,50);
                    ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=2;
                    ctx.beginPath(); const off = Math.sin(now/400 + x/2)*10;
                    ctx.moveTo(px, py+25+off); ctx.lineTo(px+50, py+25-off); ctx.stroke();
                }
                else { 
                    ctx.fillStyle = wallCol; ctx.fillRect(px, py, 50, 50);
                    ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(px, py); ctx.lineTo(px+50, py); ctx.moveTo(px, py+25); ctx.lineTo(px+50, py+25);
                    ctx.moveTo(px, py+50); ctx.lineTo(px+50, py+50);
                    ctx.moveTo(px, py); ctx.lineTo(px, py+25); ctx.moveTo(px+25, py+25); ctx.lineTo(px+25, py+50); ctx.moveTo(px+50, py); ctx.lineTo(px+50, py+25);
                    ctx.stroke();
                }
            }
        }
        
        if(this.exit) {
            ctx.save(); ctx.translate(this.exitPos.x, this.exitPos.y);
            ctx.fillStyle='#000';ctx.beginPath();ctx.arc(0,0,30,0,6.28);ctx.fill();
            ctx.strokeStyle='#795548'; ctx.lineWidth=4;
            ctx.beginPath(); ctx.moveTo(-12,-30); ctx.lineTo(-12,30); ctx.moveTo(12,-30); ctx.lineTo(12,30);
            for(let i=-2; i<=2; i++) { ctx.moveTo(-12, i*12); ctx.lineTo(12, i*12); } 
            ctx.stroke();
            ctx.fillStyle='#ffd700';ctx.font='14px serif';ctx.textAlign='center';
            ctx.fillText(LANG[curLang].labels.exit,0,-40); 
            ctx.fillText("â¬‡",0,0);
            ctx.restore();
        }

        this.ents.forEach(e=>{
            ctx.save(); ctx.translate(e.x,e.y);
            if(e.draw)e.draw(ctx);
            ctx.restore();
        });
        
        this.texts.forEach(t=>{
            ctx.save(); ctx.translate(t.x,t.y); t.draw(ctx); ctx.restore();
        });
        
        if(this.exit && this.p.hasCompass) {
            let target = this.exitPos;
            if(!this.exit && this.artifactPos) target = this.artifactPos;
            const dx=target.x-this.p.x, dy=target.y-this.p.y;
            const ang=Math.atan2(dy,dx);
            ctx.translate(this.p.x, this.p.y); ctx.rotate(ang); ctx.translate(70, 0);
            ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
            ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.fill();
            ctx.shadowBlur=0;
        }

        ctx.restore();
        
        if(this.p.buffs.candle <= 0) {
            const g=ctx.createRadialGradient(w/2,h/2,30,w/2,h/2,this.p.sight);
            g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.98)');
            ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
        }
    }
};

document.getElementById('start-btn').onclick=()=>{
    document.getElementById('start-screen').style.display='none';
    AudioSys.init(); Game.init();
};
</script>
</body>
</html>
